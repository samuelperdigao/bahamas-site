<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BAHAMAS - Controle Financeiro e Metas</title>
  <style>
    body { margin:0; background:#000; color:#e5e7eb; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial }
    .container{ max-width:1200px; margin:32px auto; padding:0 16px }
    /* Cabeçalho com logo à esquerda e título centralizado */
    header{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:16px; padding:20px }
    .logo-wrap{ justify-self:start }
    .title-wrap{ justify-self:center; text-align:center }
    .actions-wrap{ justify-self:end }
    header img{ height:80px; border-radius:8px; background:#0b0b0b; outline:2px solid #ff4db8; outline-offset:4px }
    header h1{ color:#ff4db8; font-size:60px; margin:0 }

    nav{ text-align:center; margin:10px 0 20px }
    nav a{ color:#ff4db8; text-decoration:none; font-weight:700; margin:0 10px }

    .card{ background:#111; border:1px solid #333; border-radius:14px; padding:16px; margin-bottom:20px }
    .row{ display:flex; gap:12px; flex-wrap:wrap }
    label{ display:flex; flex-direction:column; gap:6px; flex:1; min-width:160px }
    input, select, button{ appearance:none; border:1px solid #333; background:#000; color:#e5e7eb; padding:10px; border-radius:10px }
    .btn{ padding:10px 14px; border-radius:10px; border:1px solid #444; background:#222; color:#e5e7eb; cursor:pointer }
    .btn.primary{ background:#ff4db8; border-color:#ff4db8; color:#000; font-weight:700 }
    table{ width:100%; border-collapse:collapse }
    th,td{ padding:10px; border-bottom:1px solid #333; text-align:left }
    th{ color:#ccc; font-weight:600 }
    tr:hover td{ background:#1a1a1a }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; font-size:12px }
    .pill.in{ color:#9ef3c1; background:#092216; border:1px solid #134e30 }
    .pill.out{ color:#fecaca; background:#2a0e10; border:1px solid #581a1a }
    .pill.ok{ color:#bbf7d0; background:#0b2315; border:1px solid #134e30 }
    .pill.pending{ color:#fde68a; background:#251c07; border:1px solid #4b3410 }
    .kpi{ font-weight:700; margin-top:8px }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo-wrap">
        <img id="logoImg" src="" alt="Logo Bahamas" />
      </div>
      <div class="title-wrap">
        <h1>BAHAMAS</h1>
      </div>
      <div class="actions-wrap">
        <label class="btn" style="cursor:pointer">Carregar logo
          <input id="logoInput" type="file" accept="image/*" style="display:none">
        </label>
      </div>
    </header>

    <nav>
      <a href="#financeiro">Controle Financeiro</a>
      <a href="#metas">Metas Semanais</a>
    </nav>

    <!-- Parte 1: Controle Financeiro -->
    <section class="card" id="financeiro">
      <h2>Controle Financeiro</h2>
      <form id="formTx" class="row" autocomplete="off">
        <label>
          Tipo
          <select id="txType" required>
            <option value="in">Entrada</option>
            <option value="out">Saída</option>
          </select>
        </label>
        <label>
          Data
          <input type="date" id="txDate" required>
        </label>
        <label>
          Categoria
          <input type="text" id="txCat" placeholder="Ex.: Mensalidade" required>
        </label>
        <label>
          Valor (R$)
          <input type="number" id="txVal" step="0.01" min="0" required>
        </label>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn primary" type="submit" id="btnAddTx">Adicionar</button>
          <button class="btn" type="button" id="btnCancelEditTx" style="display:none">Cancelar edição</button>
        </div>
      </form>

      <div class="kpi">Saldo Total: <span id="saldoTotal">R$ 0,00</span></div>

      <div style="overflow:auto; margin-top:14px">
        <table id="tblTx">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Data</th>
              <th>Categoria</th>
              <th>Valor</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Parte 2: Metas Semanais -->
    <section class="card" id="metas">
      <h2>Metas Semanais (Funcionários)</h2>
      <div class="row" style="margin-bottom:10px">
        <label>
          Data (filtro)
          <input type="date" id="gFilterWeek">
        </label>
        <label>
          Tipo
          <select id="gFilterKind">
            <option value="">Todos</option>
            <option value="FARM">FARM</option>
            <option value="DINHEIRO SUJO">DINHEIRO SUJO</option>
          </select>
        </label>
        <label>
          Funcionário
          <select id="gFilterName"><option value="">Todos</option></select>
        </label>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn" type="button" id="btnApplyGFilter">Aplicar</button>
          <button class="btn" type="button" id="btnClearGFilter">Limpar</button>
        </div>
      </div>

      <form id="formGoal" class="row" autocomplete="off">
        <label>
          Funcionário
          <input list="namesList" id="gName" placeholder="Nome" required>
          <datalist id="namesList"></datalist>
        </label>
        <label>
          Data (qualquer dia)
          <input type="date" id="gWeek" required>
        </label>
        <label>
          Tipo
          <select id="gKind" required>
            <option value="FARM">FARM</option>
            <option value="DINHEIRO SUJO">DINHEIRO SUJO</option>
          </select>
        </label>
        <label>
          Entregue
          <div class="row" style="gap:8px">
            <input type="number" id="gDone" min="0" step="1" style="flex:2" required>
            <select id="gMeasure" style="flex:1">
              <option value="UNIDADES">UNIDADES</option>
              <option value="REAIS">REAIS</option>
            </select>
          </div>
        </label>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn primary" type="submit" id="btnAddGoal">Adicionar</button>
          <button class="btn" type="button" id="btnCancelEditGoal" style="display:none">Cancelar edição</button>
        </div>
      </form>

      <div style="overflow:auto; margin-top:20px">
        <table id="tblGoals">
          <thead>
            <tr>
              <th>Funcionário</th>
              <th>Data</th>
              <th>Tipo</th>
              <th>Entregue</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    // ===== Util =====
    const BRL = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
    const fmtDate = s=> s? new Date(s).toLocaleDateString('pt-BR'):'';
    const id = ()=> Math.random().toString(36).slice(2,10);
    const today = ()=> new Date().toISOString().slice(0,10);

    const store = {
      read:(k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } },
      write:(k,v)=> localStorage.setItem(k, JSON.stringify(v))
    };

    let transactions = store.read('cf_transactions', []);
    let goals = store.read('cf_goals', []);

    // ===== Logo =====
    const logoImg = document.getElementById('logoImg');
    document.getElementById('logoInput').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const fr = new FileReader();
      fr.onload = ()=>{ const dataUrl = fr.result; logoImg.src = dataUrl; localStorage.setItem('cf_logo', dataUrl); };
      fr.readAsDataURL(f);
    });

    async function autoLoadLogo(){
      const saved = localStorage.getItem('cf_logo');
      if(saved){ logoImg.src = saved; return; }
      const candidates = ['bahamas-logo.png','logo.png','logo.jpg','bahamas.png','bahamas.jpg'];
      for(const url of candidates){
        const ok = await imgExists(url); if(ok){ logoImg.src = url; return; }
      }
      // fallback SVG embutido
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='320' height='90'><rect width='100%' height='100%' fill='black'/><text x='50%' y='55%' fill='#ff4db8' font-family='Inter,system-ui,sans-serif' font-weight='800' font-size='42' text-anchor='middle'>BAHAMAS</text></svg>`;
      logoImg.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg);
    }
    function imgExists(url){
      return new Promise(res=>{ const i=new Image(); i.onload=()=>res(true); i.onerror=()=>res(false); i.src=url; });
    }

    // ===== Financeiro =====
    const tblTxBody = document.querySelector('#tblTx tbody');
    let editingTxId = null;

    function calcSaldo(){
      const total = transactions.reduce((acc,r)=> acc + (r.type==='in'? r.value : -r.value), 0);
      document.getElementById('saldoTotal').textContent = BRL.format(total);
    }

    function renderTx(){
      tblTxBody.innerHTML='';
      for(const r of transactions){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="pill ${r.type==='in'?'in':'out'}">${r.type==='in'?'Entrada':'Saída'}</span></td>
          <td>${fmtDate(r.date)}</td>
          <td>${escapeHtml(r.category)}</td>
          <td>${BRL.format(r.value)}</td>
          <td>
            <button class="btn" data-act="edit" data-id="${r.id}">Editar</button>
            <button class="btn" data-act="del" data-id="${r.id}">Excluir</button>
          </td>`;
        tblTxBody.appendChild(tr);
      }
      calcSaldo();
      refreshNameFilters();
    }

    document.getElementById('formTx').addEventListener('submit',(ev)=>{
      ev.preventDefault();
      const rec = {
        id: editingTxId || id(),
        type: document.getElementById('txType').value,
        date: document.getElementById('txDate').value,
        category: document.getElementById('txCat').value.trim(),
        value: Number(document.getElementById('txVal').value)
      };
      if(editingTxId){
        transactions = transactions.map(x=> x.id===editingTxId? rec : x);
      } else {
        transactions.push(rec);
      }
      store.write('cf_transactions', transactions);
      editingTxId = null;
      document.getElementById('btnCancelEditTx').style.display='none';
      ev.target.reset();
      document.getElementById('txDate').value = today();
      renderTx();
    });

    tblTxBody.addEventListener('click',(ev)=>{
      const b = ev.target.closest('button'); if(!b) return;
      const act = b.getAttribute('data-act'); const rid = b.getAttribute('data-id');
      if(act==='del'){
        transactions = transactions.filter(x=>x.id!==rid);
        store.write('cf_transactions', transactions);
        renderTx();
      } else if(act==='edit'){
        const r = transactions.find(x=>x.id===rid); if(!r) return;
        document.getElementById('txType').value = r.type;
        document.getElementById('txDate').value = r.date;
        document.getElementById('txCat').value = r.category;
        document.getElementById('txVal').value = r.value;
        editingTxId = rid;
        document.getElementById('btnCancelEditTx').style.display='inline-flex';
      }
    });

    document.getElementById('btnCancelEditTx').onclick = ()=>{
      editingTxId=null; document.getElementById('formTx').reset();
      document.getElementById('txDate').value=today();
      document.getElementById('btnCancelEditTx').style.display='none';
    };

    // ===== Metas =====
    const tblGBody = document.querySelector('#tblGoals tbody');
    let editingGoalId = null;

    function statusFromDone(done){ return Number(done) >= 150000 ? 'OK' : 'Pendente'; }

    function applyGFilters(list){
      const w = document.getElementById('gFilterWeek').value;
      const k = document.getElementById('gFilterKind').value;
      const n = document.getElementById('gFilterName').value.trim().toLowerCase();
      return list.filter(r=>{
        const okW = !w || r.week===w;
        const okK = !k || r.kind===k;
        const okN = !n || r.name.toLowerCase()===n;
        return okW && okK && okN;
      });
    }

    function renderGoals(){
      tblGBody.innerHTML='';
      const filtered = applyGFilters(goals);
      for(const r of filtered){
        const st = statusFromDone(r.done);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(r.name)}</td>
          <td>${fmtDate(r.week)}</td>
          <td>${escapeHtml(r.kind)}</td>
          <td>${r.done} ${r.measure}</td>
          <td><span class="pill ${st==='OK'?'ok':'pending'}">${st}</span></td>
          <td>
            <button class="btn" data-gact="edit" data-id="${r.id}">Editar</button>
            <button class="btn" data-gact="del" data-id="${r.id}">Excluir</button>
          </td>`;
        tblGBody.appendChild(tr);
      }
      refreshNameFilters();
    }

    document.getElementById('formGoal').addEventListener('submit',(ev)=>{
      ev.preventDefault();
      const rec = {
        id: editingGoalId || id(),
        name: document.getElementById('gName').value.trim(),
        week: document.getElementById('gWeek').value,
        kind: document.getElementById('gKind').value,
        done: Number(document.getElementById('gDone').value),
        measure: document.getElementById('gMeasure').value
      };
      if(editingGoalId){ goals = goals.map(x=> x.id===editingGoalId? rec : x); }
      else { goals.push(rec); }
      store.write('cf_goals', goals);
      editingGoalId = null;
      document.getElementById('btnCancelEditGoal').style.display='none';
      ev.target.reset();
      renderGoals();
    });

    tblGBody.addEventListener('click',(ev)=>{
      const b = ev.target.closest('button'); if(!b) return;
      const act = b.getAttribute('data-gact'); const rid = b.getAttribute('data-id');
      if(act==='del'){
        goals = goals.filter(x=>x.id!==rid);
        store.write('cf_goals', goals);
        renderGoals();
      } else if(act==='edit'){
        const r = goals.find(x=>x.id===rid); if(!r) return;
        document.getElementById('gName').value = r.name;
        document.getElementById('gWeek').value = r.week;
        document.getElementById('gKind').value = r.kind;
        document.getElementById('gDone').value = r.done;
        document.getElementById('gMeasure').value = r.measure;
        editingGoalId = rid;
        document.getElementById('btnCancelEditGoal').style.display='inline-flex';
      }
    });

    document.getElementById('btnCancelEditGoal').onclick = ()=>{
      editingGoalId=null; document.getElementById('formGoal').reset();
      document.getElementById('btnCancelEditGoal').style.display='none';
    };

    // Filtros metas
    document.getElementById('btnApplyGFilter').onclick = ()=>{ renderGoals(); };
    document.getElementById('btnClearGFilter').onclick = ()=>{
      document.getElementById('gFilterWeek').value='';
      document.getElementById('gFilterKind').value='';
      document.getElementById('gFilterName').value='';
      renderGoals();
    };

    function refreshNameFilters(){
      const names = Array.from(new Set(goals.map(g=>g.name))).sort((a,b)=>a.localeCompare(b));
      const list = document.getElementById('namesList');
      list.innerHTML = names.map(n=>`<option value="${n}"></option>`).join('');
      const filt = document.getElementById('gFilterName');
      const cur = filt.value;
      filt.innerHTML = '<option value="">Todos</option>' + names.map(n=>`<option value="${n}">${n}</option>`).join('');
      if(names.includes(cur)) filt.value = cur; else filt.value='';
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

    // ===== Init =====
    document.addEventListener('DOMContentLoaded', async ()=>{
      document.getElementById('txDate').value = today();
      document.getElementById('gWeek').value = today();
      await autoLoadLogo();
      renderTx();
      renderGoals();
    });
  </script>
</body>
</html>
